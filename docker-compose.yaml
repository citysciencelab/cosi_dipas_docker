version: '3'
services:
  proxy:
    image: nginx:stable
    ports:
      - '3000:80'
    volumes:
      - ./services/proxy/configs/default.conf:/etc/nginx/conf.d/default.conf
      - ./services/proxy/configs/vhosts:/etc/nginx/conf.d/sites-enabled

  postgis:
    image: postgis/postgis:14-master
    volumes:
      - ./services/postgis/data/pg_data:/var/lib/postgresql
    env_file:
      - ./services/postgis/config

  pgadmin:
    image: dpage/pgadmin4:5
    depends_on:
      - postgis
    ports:
      - "8888:80"
    env_file:
      - ./services/pgadmin/config

  masterportal:
    container_name: "unitac_cosi"
    image: node:16.16
    user: node
    expose:
      - 3000
    depends_on:
      - proxy
    command: 'npx serve ./dist/temp'
    # command: 'npm start'
    working_dir: /home/node/workspace
    volumes:
      - ../hcu-unitac-masterportal:/home/node/workspace
      - ../hcu-unitac-cosi:/home/node/workspace/addons
      - ../hcu-mpportalconfigs/cosi:/home/node/workspace/portal/cosi
    env_file:
      - ./services/masterportal/config

  cosi:
    container_name: "unitac_cosi"
    image: node:16.16
    user: node
    command: 'npm start'
    working_dir: /home/node/workspace
    volumes:
      - ../hcu-unitac-cosi:/home/node/workspace
    env_file:
      - ./services/cosi/config

  #dipas_apache:
  #  container_name: "unitac_dipas_apache"
  #  image: bitnami/apache:2.4.41
  #  depends_on:
  #    - dipas_php
  #  volumes:
  #    - ./services/dipas/code:/app:delegated
  #    - ./services/dipas/code/.htaccess:/opt/bitnami/apache/conf/htaccess/.htaccess
  #    - ./services/dipas/docker/apache/dipas_vhost.conf:/vhosts/my_vhost.conf:ro
  #    #- ../cosi/code/dist:/app/:delegated

  dipas_backend:
    build:
      context: ./services/dipas/docker/php
      dockerfile: ./Dockerfile-php
    depends_on:
      - postgis
    ports:
      - "2222:22"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./services/dipas/code:/app:delegated
      - ./services/dipas/configs/drupal.database-settings.php:/app/config/drupal.database-settings.php:delegated
      #- ./services/dipas/docker/php/php.ini:/opt/bitnami/php/etc/conf.d/php.ini:ro
      #- ./services/dipas/docker/php/pg.ini:/opt/bitnami/php/etc/conf.d/pg.ini:ro
    env_file:
      - ./services/dipas/configs/backend_php

  dipas_frontend:
    image: node:10
    depends_on:
      - dipas_backend
    command: bash -c 'npm run serve'
    working_dir: /usr/src/app
    ports:
      - "8081:8081"
    volumes:
      - ./services/dipas/code:/usr/src/app/

  #dipas_githook:
  #  build:
  #    context: ./services/dipas/code
  #    dockerfile: ./Dockerfile.githooks
  #  volumes:
  #    - ./services/dipas/code/.git:/tmp/.git
  #    - ./services/dipas/code/hooks:/tmp/hooks

  # Geoserver
  geoserver:
    container_name: "unitac_geoserver"
    image: kartoza/geoserver:latest
    ports:
      - "8080"
    depends_on:
      - postgis
    volumes:
      - ./services/geoserver/data/geoserver:/opt/geoserver/data_dir
    env_file:
      - ./services/geoserver/configs/geoserver

  # Open Route Service
  #open_route_service:
  #  container_name: "unitac_open-route-service"
  #  image: openrouteservice/openrouteservice:latest
  #  user: "${ORS_UID:-0}:${ORS_GID:-0}"
  #  volumes:
  #    - ./data/graphs:/ors-core/data/graphs
  #    - ./data/elevation_cache:/ors-core/data/elevation_cache
  #    - ./data/conf:/ors-conf
  #    #- ./data/import/your_osm.pbf:/ors-core/data/osm_file.pbf
  #    - ./logs/ors:/var/log/ors
  #    - ./logs/tomcat:/usr/local/tomcat/logs
  #  env_file:
  #    - ./configs/open-route-service
